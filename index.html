<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>金門回聲｜沉浸・集章・巡禮</title>

  <!-- Bootstrap 5.3.8 + Font Awesome 7 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- jQuery + Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="icon-192.png">

  <style>
    html, body { height: 100%; }
    body{background:#f7f7f9;}

    /* Map */
    #map{height:48vh;border-radius:8px;border:1px solid #dee2e6;}
    @media (min-width:1200px){ #map{height:56vh;} }

    /* Tags / chips */
    .tag{display:inline-block;padding:.2rem .5rem;border:1px solid #adb5bd;border-radius:999px;font-size:.8rem;margin-right:.25rem;color:#495057;background:#fff;}
    .filter-pill{cursor:pointer}
    .filter-pill.active{background:#0d6efd;color:#fff;border-color:#0d6efd}
    .list-empty{padding:3rem 1rem;color:#868e96;text-align:center}

    /* Card collected stamp */
    .card.collected{border-color:#20c997;box-shadow:0 0 0 .2rem rgba(32,201,151,.15);}
    .stamp{position:absolute;right:.5rem;bottom:.5rem;width:78px;height:78px;border:4px solid #d6336c;color:#d6336c;border-radius:50%;
           display:flex;align-items:center;justify-content:center;font-weight:800;letter-spacing:.15em;font-size:.9rem;
           transform: rotate(-12deg) scale(0);opacity:0;background: rgba(214,51,108,.06);pointer-events:none;}
    .card.collected .stamp{transform: rotate(-12deg) scale(1);opacity:.92;transition: transform .25s ease, opacity .25s ease;}
    @keyframes stampIn {0%{transform: rotate(-12deg) scale(.1);opacity:.0;}60%{transform: rotate(-12deg) scale(1.15);opacity:1;}100%{transform: rotate(-12deg) scale(1);opacity:.92;}}
    .stamp.punch{animation: stampIn .38s cubic-bezier(.2,1,.2,1);}

    /* Badge chips */
    .badge-chip{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .6rem;border-radius:999px;font-weight:600;border:1px solid #dee2e6;background:#fff;color:#495057;}
    .badge-strong{background:#198754;color:#fff;border-color:#198754;}
    .badge-muted{background:#f1f3f5;color:#6c757d;}
    .pop-zoom{animation:pop .4s ease;}
    @keyframes pop{from{transform:scale(.6);opacity:.2}to{transform:scale(1);opacity:1}}

    /* 仍保留 Navbar 為最上層 sticky */
    .navbar.sticky-top { position: sticky; top: 0; z-index: 1030; }
    
    /* 第一層：進度列 */
    .subbar-1{ position: sticky; top: var(--navH,56px); z-index: 1020; background:#fff; border-bottom:1px solid #e9ecef; }
    
    /* 第二層（新）：徽章(可收合) + 分類（同一層） */
    .sticky-stack{
      position: sticky;
      top: calc(var(--navH,56px) + var(--bar1H,48px)); /* 緊貼第一層底下 */
      z-index: 1015;
      background:#fff;
      border-bottom:1px solid #e9ecef;
      overflow: hidden;              /* 關鍵：避免 collapse 高度動畫時露出底層畫面 */
    }

    /* 統一邊線：用相鄰選擇器把 1px 重疊，消除「縫隙」 */
    .subbar { border-bottom:1px solid #e9ecef; }
    .subbar + .subbar { margin-top:-1px; } /* 關鍵：把相鄰兩條底線重疊 → 看起來無縫 */

    /* Sticky 需要父層不能 overflow hidden/auto，預設 body 無此問題；此處保險處理主要容器 */
    .container, .container-fluid { overflow: visible; }
  </style>
</head>
<body>

  <!-- Navbar（固定不滾動） -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top" id="topNav">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold" href="#">
        <i class="fa-solid fa-feather-pointed me-2"></i>金門回聲｜沉浸・集章・巡禮
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent" aria-controls="navContent" aria-expanded="false" aria-label="切換導覽">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div id="navContent" class="collapse navbar-collapse justify-content-end mt-2 mt-lg-0">
        <div class="w-100 w-lg-auto d-flex flex-column flex-lg-row align-items-stretch align-items-lg-center gap-2">
          <div class="input-group flex-grow-1">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input id="kw" type="search" class="form-control" placeholder="搜尋名稱、關鍵字…">
          </div>
          <div class="d-grid d-lg-block">
            <button id="btnReset" class="btn btn-outline-secondary text-nowrap w-100 w-lg-auto mt-2 mt-lg-0">
              <i class="fa-solid fa-rotate-left"></i> 重設
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- 進度列（Sticky 第一層） -->
  <div class="py-2 bg-light subbar subbar-1">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between mb-1">
        <div class="small text-muted">進度：<span id="progressText">0 / 0</span></div>
        <div class="d-flex align-items-center gap-2">
          <button id="btnAllBadges" class="btn btn-sm btn-outline-primary">
            <i class="fa-solid fa-award me-1"></i>查看全部徽章
          </button>

          <!-- A2HS：可安裝才會顯示（Android 原生 / iOS 教學同一顆按鈕） -->
          <button id="btnA2HS" class="btn btn-sm btn-success d-none">
            <i class="fa-solid fa-plus"></i> 新增到主畫面
          </button>

          <!-- 這顆按鈕直接綁 Bootstrap Collapse -->
          <button id="btnToggleBadges"
                  class="btn btn-sm btn-outline-secondary"
                  data-bs-toggle="collapse"
                  data-bs-target="#badgeCollapse"
                  aria-controls="badgeCollapse"
                  aria-expanded="false">
            <i class="fa-solid fa-chevron-down me-1"></i> 展開徽章
          </button>
        </div>
      </div>
      <div class="progress" role="progressbar" aria-label="collection progress">
        <div id="progressBar" class="progress-bar" style="width:0%">0%</div>
      </div>
    </div>
  </div>

  <!-- 徽章 + 分類（同一層 Sticky 第二層） -->
  <div class="sticky-stack">
    <div id="badgeCollapse" class="collapse">
      <div class="container py-2">
        <div id="badgesRow" class="d-flex flex-wrap align-items-center gap-2"></div>
      </div>
    </div>
    <div class="container py-2">
      <div id="catFilters" class="d-flex flex-wrap gap-2"></div>
    </div>
  </div>

  <!-- 主內容 -->
  <div class="container my-3">
    <div id="map" class="mb-3"></div>

    <div id="list" class="row g-3"></div>
    <div id="empty" class="list-empty d-none">
      <i class="fa-regular fa-face-meh"></i> 沒有符合條件的項目。
    </div>
  </div>

  <!-- 詳情 Modal -->
  <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="mdTitle" class="modal-title"></h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
        </div>
        <div class="modal-body">
          <div id="mdTags" class="mb-2"></div>
          <p id="mdDesc" class="mb-3"></p>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="small text-muted mb-1">地點</div>
                  <div id="mdAddr" class="fw-medium"></div>
                  <div class="text-muted small">座標：<span id="mdCoord"></span></div>
                  <a id="mdNav" href="#" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                    <i class="fa-solid fa-location-arrow"></i> 用地圖導航
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted mb-1">小挑戰（任務）</div>
                  <ul id="mdQuests" class="mb-0"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button id="mdCollectBtn" class="btn btn-success"><i class="fa-solid fa-stamp"></i> 蒐集 / 取消蒐集</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 解鎖徽章 Modal -->
  <div class="modal fade" id="badgeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4 pop-zoom">
        <div class="display-3 mb-3" id="badgeIcon"><i class="fa-solid fa-certificate"></i></div>
        <h5 id="badgeTitle" class="mb-2">解鎖徽章！</h5>
        <p id="badgeDesc" class="text-muted mb-0"></p>
        <div class="mt-3"><button class="btn btn-success" data-bs-dismiss="modal"><i class="fa-solid fa-check"></i> 太棒了！</button></div>
      </div>
    </div>
  </div>

  <!-- 全部徽章 Modal -->
  <div class="modal fade" id="allBadgesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-award me-2"></i>全部徽章一覽</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
        </div>
        <div class="modal-body">
          <h6 class="text-muted mb-2">全域徽章</h6>
          <div id="allBadgeGlobal" class="d-flex flex-wrap gap-2 mb-3"></div>
          <h6 class="text-muted mb-2">分類徽章門檻</h6>
          <div id="allBadgeCats"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- iOS 加到主畫面教學 Modal -->
  <div class="modal fade" id="iosA2HSModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-plus me-2"></i>新增到主畫面</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
        </div>
        <div class="modal-body">
          <ol class="mb-0">
            <li>使用 Safari 開啟本頁（iPhone / iPad）。</li>
            <li>點右下角的 <strong>分享</strong> 按鈕。</li>
            <li>選擇 <strong>加入主畫面</strong>，再點 <strong>加入</strong>。</li>
          </ol>
          <div class="small text-muted mt-2">提示：若已安裝或以獨立視窗開啟，按鈕會自動隱藏。</div>
        </div>
      </div>
    </div>
  </div>

  <!-- App JS + PWA -->
  <script src="app.js"></script>
  <script src="pwa.js"></script>
</body>
</html>
