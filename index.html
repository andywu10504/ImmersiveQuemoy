<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>金門回聲｜沉浸・集章・巡禮</title>

<!-- Bootstrap 5.3.8 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

<!-- Font Awesome 7.0.1 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Leaflet (OSM 地圖) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

<style>
  body{background:#f7f7f9;}
  #map{height:48vh;border-radius:8px;border:1px solid #dee2e6;}
  .tag{display:inline-block;padding:.2rem .5rem;border:1px solid #adb5bd;border-radius:999px;font-size:.8rem;margin-right:.25rem;color:#495057;background:#fff;}
  .filter-pill{cursor:pointer}
  .filter-pill.active{background:#0d6efd;color:#fff;border-color:#0d6efd}
  .list-empty{padding:3rem 1rem;color:#868e96;text-align:center}

  .card.collected{
    border-color:#20c997;
    box-shadow:0 0 0 .2rem rgba(32,201,151,.15);
  }
  .stamp{
    position:absolute; right:.5rem; bottom:.5rem;
    width:78px; height:78px;
    border:4px solid #d6336c; color:#d6336c;
    border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-weight:800; letter-spacing:.15em; font-size:.9rem;
    transform: rotate(-12deg) scale(0);
    opacity:0; background: rgba(214,51,108,.06);
    pointer-events:none;
  }
  .card.collected .stamp{
    transform: rotate(-12deg) scale(1);
    opacity:.92; transition: transform .25s ease, opacity .25s ease;
  }
  @keyframes stampIn {
    0%{ transform: rotate(-12deg) scale(.1); opacity:.0; }
    60%{ transform: rotate(-12deg) scale(1.15); opacity:1; }
    100%{ transform: rotate(-12deg) scale(1); opacity:.92; }
  }
  .stamp.punch{ animation: stampIn .38s cubic-bezier(.2,1,.2,1); }

  .badge-chip{
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.25rem .6rem; border-radius:999px; font-weight:600; border:1px solid #dee2e6; background:#fff; color:#495057;
  }
  .badge-strong{background:#198754; color:#fff; border-color:#198754;}
  .badge-muted {background:#f1f3f5; color:#6c757d;}
  .pop-zoom { animation:pop .4s ease; }
  @keyframes pop { from{transform:scale(.6); opacity:.2} to{transform:scale(1); opacity:1} }
  @media (min-width:1200px){ #map{height:56vh;} }
  
  /* 讓三段頭區固定：navbar 用 Bootstrap 的 sticky-top；下面兩段用 position: sticky */
.subbar {
  position: sticky;
  z-index: 1020;            /* 介於 navbar(1030) 與內容之間，避免被覆蓋 */
  background: #fff;         /* 確保遮擋時不透明 */
}

/* 第一段（進度列）貼在 navbar 下方 */
.subbar-1 { top: var(--navH, 56px); }

/* 第二段（徽章列）貼在進度列下方 */
.subbar-2 { top: calc(var(--navH, 56px) + var(--bar1H, 48px)); }
  
  /* 第三段（分類篩選）貼在徽章列下方 */
.subbar-3 {
  position: sticky;
  top: calc(var(--navH, 56px) + var(--bar1H, 48px) + var(--bar2H, 40px));
  z-index: 1015;           /* 低於 navbar(1030)、略高於內容 */
  background: #fff;         /* 滾動時不透底 */
  border-bottom: 1px solid #e9ecef;
}

/* 讓主內容不被覆蓋：在 sticky 區塊之後的容器上方預留空間（僅在需要時使用） */
/* 如果你發現最上面的內容被 sticky 區塊蓋住，可以開啟這段： */
/*
.container.my-3 {
  scroll-margin-top: calc(var(--navH, 56px) + var(--bar1H, 48px) + var(--bar2H, 40px) + 16px);
}
*/

</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top" id="topNav">
  <div class="container-fluid px-3">
    <a class="navbar-brand fw-bold" href="#">
      <i class="fa-solid fa-person-hiking me-2"></i>金門回聲｜沉浸・集章・巡禮
    </a>

    <!-- 三條線按鈕 -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
      data-bs-target="#navContent" aria-controls="navContent"
      aria-expanded="false" aria-label="切換導覽">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- 展開內容 -->
    <div id="navContent" class="collapse navbar-collapse justify-content-end mt-2 mt-lg-0">
      <div class="w-100 w-lg-auto d-flex flex-column flex-lg-row align-items-stretch align-items-lg-center gap-2">
        <!-- 搜尋列：在手機時滿版 -->
        <div class="input-group flex-grow-1">
          <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
          <input id="kw" type="search" class="form-control" placeholder="搜尋名稱、關鍵字…">
        </div>
        <!-- 重設鈕：在手機時換行置下 -->
        <div class="d-grid d-lg-block">
          <button id="btnReset" class="btn btn-outline-secondary text-nowrap w-100 w-lg-auto mt-2 mt-lg-0">
            <i class="fa-solid fa-rotate-left"></i> 重設
          </button>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="py-2 bg-light border-bottom subbar subbar-1">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-1">
      <div class="small text-muted">
        進度：<span id="progressText">0 / 0</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button id="btnAllBadges" class="btn btn-sm btn-outline-primary">
          <i class="fa-solid fa-award me-1"></i>查看全部徽章
        </button>
        <!-- 新增：收合徽章列的切換鈕 -->
        <button class="btn btn-sm btn-outline-secondary"
                data-bs-toggle="collapse"
                data-bs-target="#badgeCollapse"
                aria-expanded="true"
                aria-controls="badgeCollapse">
          <i class="fa-solid fa-chevron-up me-1"></i> 收合徽章
        </button>
      </div>
    </div>
    <div class="progress" role="progressbar" aria-label="collection progress">
      <div id="progressBar" class="progress-bar" style="width:0%">0%</div>
    </div>
  </div>
</div>

<!-- 篩選 -->
<div class="subbar subbar-2 bg-white border-bottom">
  <div id="badgeCollapse" class="collapse show">
    <div class="container py-2">
      <div id="badgesRow" class="d-flex flex-wrap align-items-center gap-2"></div>
    </div>
  </div>
</div>


<div class="subbar subbar-3 bg-white border-bottom">
  <div class="container py-2">
    <div id="catFilters" class="d-flex flex-wrap gap-2"></div>
  </div>
</div>

  <div id="map" class="mb-3"></div>

  <div id="list" class="row g-3"></div>
  <div id="empty" class="list-empty d-none">
    <i class="fa-regular fa-face-meh"></i> 沒有符合條件的項目。
  </div>
</div>

<!-- 詳情 -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="mdTitle" class="modal-title"></h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <div id="mdTags" class="mb-2"></div>
        <p id="mdDesc" class="mb-3"></p>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card"><div class="card-body">
              <div class="small text-muted mb-1">地點</div>
              <div id="mdAddr" class="fw-medium"></div>
              <div class="text-muted small">座標：<span id="mdCoord"></span></div>
              <a id="mdNav" href="#" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                <i class="fa-solid fa-location-arrow"></i> 用地圖導航
              </a>
            </div></div>
          </div>
          <div class="col-md-6">
            <div class="card h-100"><div class="card-body">
              <div class="small text-muted mb-1">小挑戰（任務）</div>
              <ul id="mdQuests" class="mb-0"></ul>
            </div></div>
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button id="mdCollectBtn" class="btn btn-success"><i class="fa-solid fa-stamp"></i> 蒐集 / 取消蒐集</button>
      </div>
    </div>
  </div>
</div>

<!-- 解鎖提示 -->
<div class="modal fade" id="badgeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4 pop-zoom">
      <div class="display-3 mb-3" id="badgeIcon"><i class="fa-solid fa-certificate"></i></div>
      <h5 id="badgeTitle" class="mb-2">解鎖徽章！</h5>
      <p id="badgeDesc" class="text-muted mb-0"></p>
      <div class="mt-3"><button class="btn btn-success" data-bs-dismiss="modal"><i class="fa-solid fa-check"></i> 太棒了！</button></div>
    </div>
  </div>
</div>

<!-- 全部徽章 -->
<div class="modal fade" id="allBadgesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-award me-2"></i>全部徽章一覽</h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <h6 class="text-muted mb-2">全域徽章</h6>
        <div id="allBadgeGlobal" class="d-flex flex-wrap gap-2 mb-3"></div>
        <h6 class="text-muted mb-2">分類徽章門檻</h6>
        <div id="allBadgeCats"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===============================
   CATALOG（統一生成用資料源）
   =============================== */
const CATALOG = [
  /* —— 在地文化（有座標者會上地圖） —— */

  // 戰地坑道
  { id:"P01", name:"翟山坑道", category:"戰地坑道", tags:["坑道","乘船","戰時文化"], lat:24.39030, lng:118.32054, address:"金城鎮",
    desc:"戰地時期的海防坑道，退潮與導覽配合可乘船入內，回音與光影變化是亮點。",
    quests:["錄下 10 秒回音","找一處最佳光影位置拍照"] },

  { id:"T02", name:"金城民防坑道", category:"戰地坑道", tags:["民防","坑道"], lat:24.43306, lng:118.32022, address:"金城鎮（入口：金城車站二樓）",
    desc:"1978 年建成的城區地下防空坑道，見證戰地政務時期全民防空的歷史印記。",
    quests:["安全導覽下數出轉折數","寫 20 字感想"] },

  // 太武山（地點脈絡歸此，小分類仍是你列的「太武山」）
  { id:"H01", name:"擎天廳", category:"太武山", tags:["坑道展演","聲光"], lat:24.45422, lng:118.40720, address:"太武山區",
    desc:"太武山下巨型地下空間，早年軍事設施，現為展演／聲光節目場域。",
    quests:["找最佳拍照角度（不干擾他人）","寫 20 字聲光心得"] },

  // 洋樓建築
  { id:"B02", name:"陳景蘭洋樓", category:"洋樓建築", tags:["人文建築","僑鄉風華"], lat:24.43727, lng:118.39009, address:"金湖鎮成功",
    desc:"金門規模最大的洋樓，見證南洋風格與僑鄉歷史。",
    quests:["拍 2 個立面裝飾細節","描述最喜歡的空間"] },

  { id:"B05", name:"北山古洋樓", category:"洋樓建築", tags:["聚落","裝飾細節"], lat:24.47921, lng:118.31256, address:"金寧鄉北山",
    desc:"聚落中的洋樓建築，裝飾與量體比例值得細看。",
    quests:["拍 2 個立面細節","寫 1 個最喜歡的元素"] },

  // 特約茶室
  { id:"M02", name:"特約茶室展示館", category:"特約茶室", tags:["展示館","戰地史料"], lat:24.44831, lng:118.38484, address:"金湖鎮小徑",
    desc:"再現戰地政務時期特約茶室史料，理解軍民互動的社會場景。",
    quests:["從展品撰寫 30 字心得","與同伴討論其歷史脈絡"] },

  // 書院（此處用在歷史人物／禮制脈絡，墓園歸在地文化亦可；保留到書院脈絡下）
  { id:"H02", name:"邱良功墓園", category:"書院", tags:["清代循吏","縣定古蹟"], lat:24.44989, lng:118.38593, address:"金湖鎮小徑",
    desc:"清代循吏邱良功衣冠冢，石像生與神道碑配置完整，具高歷史價值。",
    quests:["抄錄一段碑刻文字","拍一張不打擾安寧的遠景照"] },

  // 碉堡
  { id:"F01", name:"勇士堡", category:"碉堡", tags:["軍事據點","前線"], lat:24.44762, lng:118.25193, address:"烈嶼鄉",
    desc:"典型前線碉堡，可觀察射口、掩體與火力配置。",
    quests:["找 2 處射口與視野方向","說明其防禦優勢（≥20 字）"] },

  { id:"F02", name:"鐵漢堡", category:"碉堡", tags:["軍事據點","連成火網"], lat:24.44691, lng:118.25200, address:"烈嶼鄉",
    desc:"與勇士堡相鄰的據點組合，形成互補火網。",
    quests:["比較與勇士堡之布局差異","拍下彼此連線的方位"] },

  { id:"G01", name:"后麟靶場（步槍模擬射擊館）", category:"碉堡", tags:["靶場","軍事遺構"], lat:24.43903, lng:118.25882, address:"烈嶼鄉",
    desc:"早年射擊訓練場域，現留存多處標靶與遺構。",
    quests:["辨識一處射擊標示","畫下你看到的視角構圖"] },

  // 戰史館
  { id:"M04", name:"古寧頭戰史館", category:"戰史館", tags:["展館","古寧頭戰役"], lat:24.48303, lng:118.32108, address:"金寧鄉",
    desc:"仿古城堡式建築，十二幅大型油畫重現古寧頭戰役進程與人物。",
    quests:["選 1 張歷史照片寫 30 字心得","與同伴互講一段導覽"] },

  { id:"M03", name:"地雷主題館", category:"戰史館", tags:["掃雷","主題館"], lat:24.44666, lng:118.25188, address:"烈嶼鄉",
    desc:"展示金門掃雷歷程與地雷知識，向排除戰爭遺緒的無名英雄致敬。",
    quests:["記錄 1 項掃雷關鍵技術","拍下最敬佩的勇士故事牌"] },

  // 播音牆
  { id:"B04", name:"北山播音牆", category:"播音牆", tags:["心戰","冷戰遺構"], lat:24.48892, lng:118.31305, address:"金寧鄉北山",
    desc:"冷戰時期對岸心戰喊話的重要設施之一，巨構牆面具鮮明時代意義。",
    quests:["找出牆面構造特點","錄一句「和平」的祝福話語"] },

  // 摩西分海
  { id:"I01", name:"建功嶼", category:"摩西分海", tags:["潮汐步道","蚵田"], lat:24.42722, lng:118.30000, address:"金城鎮",
    desc:"退潮方能踏浪前往的小島，務必留意潮汐與行走安全。",
    quests:["查詢潮汐時刻做計畫","拍一張安全又美的遠景"] },

  // 沙灘
  { id:"B03", name:"雙口海灘", category:"沙灘", tags:["海岸","潮間帶"], lat:24.43924, lng:118.22900, address:"烈嶼鄉",
    desc:"退潮可見木柵與歷史遺構，夕陽時分景致尤佳。",
    quests:["撿 5 件垃圾守護海灘","錄 15 秒潮聲"] },

  // 在地文化（通用）
  { id:"L02", name:"莒光樓", category:"在地文化", tags:["地標","展望"], lat:24.42497, lng:118.31900, address:"金城鎮",
    desc:"金門的指標地標，登樓可眺望城區與海景，夜景亦迷人。",
    quests:["不擋人的情況下拍到整棟樓","寫下一句座右銘"] },

  // 題目卡（互動體驗，無座標）
  { id:"Q01", name:"為什麼來金門？", category:"網美景點", tags:["主題互動","自我提問"], lat:24.446090, lng:118.337510, address:"金寧鎮", desc:"作為導覽開場的自我紀錄卡。", quests:["列3件想完成的小事","回程前對照完成度"] },

  /* —— 在地飲食／名產／點心／風獅爺（不上地圖，統一可蒐集卡） —— */

  // 在地美食
  { id:"F_M_BeefNoodle", name:"牛肉麵", category:"在地美食", tags:["經典","熱食"], address:"多店家",
    desc:"濃郁湯頭與彈牙麵條的在地經典。",
    quests:["評分 1–5","拍下最療癒的一口"] },
  { id:"F_M_CantoneseCongee", name:"廣東粥", category:"在地美食", tags:["暖胃","早點"], address:"多店家",
    desc:"綿密口感的暖胃早餐代表。",
    quests:["寫 3 個風味關鍵詞","店家門面合照"] },
  { id:"F_M_StirNoodle", name:"炒泡麵", category:"在地美食", tags:["家常","快炒"], address:"多店家",
    desc:"在地家常炒麵，Q 勁與香氣兼具。",
    quests:["拍色香味","寫 20 字口感"] },
  { id:"F_M_Gyoza", name:"冰花煎餃", category:"在地美食", tags:["煎","脆邊"], address:"多店家",
    desc:"薄脆冰花邊，內餡多汁。",
    quests:["拍脆邊特寫","評 1 句口感"] },
  { id:"F_M_Oyster", name:"石蚵", category:"在地美食", tags:["海味","季節"], address:"多店家",
    desc:"潮間帶海味代表，鮮甜彈牙。",
    quests:["拍料理成品","寫最佳料理法"] },
  { id:"F_M_SunNoodle", name:"日曬麵線", category:"在地美食", tags:["手作","日曬"], address:"多店家",
    desc:"日曬工序帶出獨特勁道。",
    quests:["拍線架畫面","寫 20 字風味"] },
  { id:"F_M_Gaoliang", name:"高粱酒", category:"在地美食", tags:["烈酒","釀造"], address:"多店家",
    desc:"在地釀造的經典烈酒。",
    quests:["負責任飲用","描述 3 個香氣詞"] },
  { id:"F_M_Taro", name:"芋頭", category:"在地美食", tags:["在地作物"], address:"多店家",
    desc:"綿密香甜的在地作物。",
    quests:["拍剖面","寫最佳料理搭配"] },
  { id:"F_M_SandWorm", name:"沙蟲", category:"在地美食", tags:["海味","限定"], address:"多店家",
    desc:"獨特的潮間帶食材。",
    quests:["寫敢不敢嘗試的理由","評 1–5"] },
  { id:"F_M_Foshou", name:"佛手貝", category:"在地美食", tags:["貝類"], address:"多店家",
    desc:"少見的貝類食材，口感獨特。",
    quests:["拍料理","寫 20 字口感"] },
  { id:"F_M_GaoliangCrab", name:"高粱嗆蟹", category:"在地美食", tags:["冷盤","酒香"], address:"多店家",
    desc:"酒香入味，鮮甜帶勁。",
    quests:["拍擺盤","寫 20 字風味"] },
  { id:"F_M_WineTangYuan", name:"酒釀湯圓", category:"在地美食", tags:["甜品","酒香"], address:"多店家",
    desc:"微酒香襯托湯圓軟糯。",
    quests:["寫 3 個風味詞","拍成品"] },
  { id:"F_M_EggRoll", name:"蛋香、蛋狗", category:"在地美食", tags:["在地點心"], address:"多店家",
    desc:"在地常見的小食點心。",
    quests:["記錄攤位","寫 20 字口感"] },
  { id:"F_M_Youtiao", name:"油條", category:"在地美食", tags:["早點"], address:"多店家",
    desc:"金黃酥脆，早餐必備。",
    quests:["拍斷面","寫最佳搭配飲品"] },
  { id:"F_M_PorkSoupNoodle", name:"肉羹麵", category:"在地美食", tags:["羹湯"], address:"多店家",
    desc:"勾芡羹湯與彈牙肉羹的組合。",
    quests:["拍湯色","寫 20 字口感"] },
  { id:"F_M_ManJianGao", name:"滿煎糕", category:"在地美食", tags:["點心"], address:"多店家",
    desc:"外酥內柔，甜香滿溢。",
    quests:["拍剖面","寫 1 句評語"] },
  { id:"F_M_GaoliangEgg", name:"高粱酒釀蛋", category:"在地美食", tags:["酒香","蛋"], address:"多店家",
    desc:"酒香浸潤的蛋料理。",
    quests:["拍成品","寫 20 字感受"] },
  { id:"F_M_ShanxiNoodle", name:"山西拌麵", category:"在地美食", tags:["拌麵","地域風味"], address:"多店家",
    desc:"麵香與醬香的直球對決。",
    quests:["拍拌勻前後","寫 20 字口味"] },

  // 在地飲品
  { id:"D_Bafenpu", name:"八分舖", category:"在地飲品", tags:["在地飲品"], address:"多店家",
    desc:"在地常見飲品品牌（據點依實際）。",
    quests:["拍杯身設計","寫 3 個風味詞"] },
  { id:"D_Gaoming", name:"高明綠豆沙", category:"在地飲品", tags:["冰飲","豆沙"], address:"多店家",
    desc:"綠豆沙香濃冰涼，沁心消暑。",
    quests:["拍杯身與綿密度","評分 1–5"] },

  // 金門名產
  { id:"S_Gaoliang", name:"高粱酒", category:"金門名產", tags:["釀造","經典"], address:"多店家",
    desc:"最具代表性的金門名產之一。",
    quests:["拍酒標","寫 3 個香氣詞"] },
  { id:"S_Yitiaogen", name:"一條根", category:"金門名產", tags:["藥草","伴手"], address:"多店家",
    desc:"在地藥草延伸的保健／伴手禮。",
    quests:["拍外盒","寫功用印象"] },
  { id:"S_Knife", name:"砲彈菜刀", category:"金門名產", tags:["鋼材","工藝"], address:"多店家",
    desc:"戰地記憶轉化的金屬工藝代表。",
    quests:["拍刀紋","寫 20 字心得"] },
  { id:"S_GongTang", name:"貢糖", category:"金門名產", tags:["花生","點心"], address:"多店家",
    desc:"香脆不黏牙，老少咸宜的伴手禮。",
    quests:["拍產品與包裝","寫 20 字口感"] },
  { id:"S_ShaoBing", name:"燒餅", category:"金門名產", tags:["爐烤","在地風味"], address:"多店家",
    desc:"層次分明、外酥內香的在地點心。",
    quests:["拍切面層次","寫最佳搭配飲品"] },
  { id:"S_GaoliangIce", name:"高粱冰淇淋", category:"金門名產", tags:["創意","冰品"], address:"多店家",
    desc:"將酒香化為甜點的創意產品。",
    quests:["拍融化前後","寫 1 句評語"] },
  { id:"S_GaoliangRoll", name:"高粱蛋捲", category:"金門名產", tags:["蛋香","酥脆"], address:"多店家",
    desc:"帶有酒香的酥脆蛋捲。",
    quests:["拍斷面","寫 20 字口感"] },
  { id:"S_WindLionSouvenir", name:"風獅爺紀念品", category:"金門名產", tags:["守護","象徵"], address:"多店家",
    desc:"把守護意象帶回家的小物。",
    quests:["拍最喜歡的一款","寫寓意"] },
  { id:"S_Tofu", name:"豆腐乳", category:"金門名產", tags:["發酵","蘸料"], address:"多店家",
    desc:"發酵風味濃郁，百搭下飯。",
    quests:["拍瓶身","寫最佳搭配"] },
  { id:"S_Jerky", name:"牛(豬)肉乾", category:"金門名產", tags:["肉乾","零嘴"], address:"多店家",
    desc:"旅行途中最方便的在地零嘴。",
    quests:["拍口味標示","寫 20 字評語"] },
  { id:"S_Seaweed", name:"紫菜酥", category:"金門名產", tags:["海味","零嘴"], address:"多店家",
    desc:"薄脆海味點心，越吃越唰嘴。",
    quests:["拍包裝","寫 1 句評語"] },
  { id:"S_Mianxian", name:"麵線", category:"金門名產", tags:["日曬","手作"], address:"多店家",
    desc:"日曬工序的麵條代表。",
    quests:["拍線架或包裝","寫料理提案"] },
  { id:"S_SourCabbage", name:"酸白菜", category:"金門名產", tags:["發酵菜"], address:"多店家",
    desc:"發酵酸香，湯鍋好夥伴。",
    quests:["拍料理","寫最佳吃法"] },
  { id:"S_BlackGarlic", name:"黑蒜頭", category:"金門名產", tags:["熟成","健康"], address:"多店家",
    desc:"熟成帶出甜韻與新風味。",
    quests:["拍內部色澤","寫風味詞"] },
  { id:"S_DutyFree", name:"免稅商品", category:"金門名產", tags:["免稅","限定"], address:"多店家",
    desc:"離島免稅的購物特色。",
    quests:["拍購物袋","寫購物心得"] },

  // 傳統點心
  { id:"T_Bucket", name:"烈嶼桶餅", category:"傳統點心", tags:["烈嶼","傳統餅"], address:"多店家",
    desc:"烈嶼在地傳統餅食。",
    quests:["拍外盒","寫 20 字口感"] },
  { id:"T_Cunjiao", name:"寸棗糖", category:"傳統點心", tags:["古早味","糖果"], address:"多店家",
    desc:"古早味甜點，口感紮實。",
    quests:["拍顆粒特寫","寫風味詞"] },
  { id:"T_OneBite", name:"一口酥", category:"傳統點心", tags:["小點","酥香"], address:"多店家",
    desc:"一口大小的酥點。",
    quests:["拍剖面","寫 1 句評語"] },
  { id:"T_NiuE", name:"牛軛餅", category:"傳統點心", tags:["古早味","在地餅"], address:"多店家",
    desc:"以牛軛意象命名的傳統餅。",
    quests:["拍餅紋","寫口感關鍵詞"] },
  { id:"T_SuoZaiGu", name:"索仔股", category:"傳統點心", tags:["傳統","點心"], address:"多店家",
    desc:"在地傳統點心之一。",
    quests:["拍外觀","寫 20 字口感"] },

  // 特色風獅爺（不放座標；可視需求日後補點位版）
  { id:"WL_99", name:"九十九尊風獅爺", category:"特色風獅爺", tags:["守護","群像"], address:"多地",
    desc:"以風獅爺守護群像為主題的蒐集任務。",
    quests:["拍 3 尊不同造型","寫你最喜歡的寓意"] },
  { id:"WL_Qionglin", name:"瓊林風獅爺", category:"特色風獅爺", tags:["瓊林"], address:"瓊林聚落",
    desc:"聚落意象濃厚的金門觀光代言者風獅爺。",
    quests:["拍與聚落環境合照","寫守護寓意"] },
  { id:"WL_Dongzhou", name:"東洲風獅爺", category:"特色風獅爺", tags:["傳說","辦案"], address:"東洲聚落",
    desc:"相傳協助村落抓兇手的風獅爺．。",
    quests:["拍合影","寫 20 字故事摘要"] },
  { id:"WL_GuanAo", name:"官澳風獅爺", category:"特色風獅爺", tags:["造型","特色"], address:"官澳聚落",
    desc:"少見穿裙子的造型。",
    quests:["拍造型重點","寫設計觀察"] },
  { id:"WL_Anqi", name:"安岐風獅爺", category:"特色風獅爺", tags:["高度","地標"], address:"安岐聚落",
    desc:"聚落中最高的風獅爺。",
    quests:["拍仰角構圖","寫 1 句評語"] },
  { id:"WL_Jinmencheng", name:"金門城風獅爺", category:"特色風獅爺", tags:["歷史","最悠久"], address:"金門城",
    desc:"歷史最悠久的風獅爺。",
    quests:["拍近景與遠景各一","寫歷史印象"] },
  { id:"WL_Xiyuan", name:"西園風獅爺", category:"特色風獅爺", tags:["郵票","紀念"], address:"金沙鎮西園",
    desc:"登上郵票的風獅爺形象。",
    quests:["拍姿態","寫 20 字寓意"] },
  { id:"WL_Qingyu", name:"青嶼風獅爺", category:"特色風獅爺", tags:["由私到公","變遷"], address:"金沙鎮青嶼",
    desc:"從私宅轉為村落供奉的故事。",
    quests:["拍供奉環境","寫 20 字心情"] },
  { id:"WL_Xiashu", name:"夏墅風獅爺", category:"特色風獅爺", tags:["可愛","造型"], address:"夏墅聚落",
    desc:"造型被暱稱為『小叮噹』。",
    quests:["拍可愛重點","寫 1 句評語"] },
  { id:"WL_Min", name:"瓊林風獅爺", category:"特色風獅爺", tags:["最小","趣味"], address:"瓊林聚落",
    desc:"金門最小的風獅爺。",
    quests:["拍比例對比","寫趣味觀察"] },
  { id:"WL_Xifang", name:"西方風獅爺", category:"特色風獅爺", tags:["百年","歷史"], address:"西方聚落",
    desc:"百年風獅爺，歷經歲月仍守護聚落。",
    quests:["拍風化細節","寫 20 字感想"] }
];

/* 將 CATALOG 統一生成 DATA 與 ITEM_BY_ID（所有卡片走同一流程） */
const { DATA, ITEM_BY_ID } = buildDataFromCatalog(CATALOG);
function buildDataFromCatalog(catalog){
  // 正規化欄位、確保 id 唯一（若未填 id，自動生成）
  const seen = new Set();
  let seq = 1;
  const normalize = (r) => {
    const id = (r.id && !seen.has(r.id)) ? r.id : autoId(r.category, seq++);
    seen.add(id);
    return {
      id,
      name: r.name || "(未命名)",
      category: r.category || "未分類",
      tags: Array.isArray(r.tags) ? r.tags : [],
      lat: (typeof r.lat === "number") ? r.lat : undefined,
      lng: (typeof r.lng === "number") ? r.lng : undefined,
      address: r.address || "—",
      desc: r.desc || "",
      quests: Array.isArray(r.quests) ? r.quests : []
    };
  };
  const data = catalog.map(normalize);
  const byId = Object.fromEntries(data.map(d => [d.id, d]));
  return { DATA:data, ITEM_BY_ID:byId };

  function autoId(cat, i){
    // 類別首字 + 序號，例如「坑道」→ K001、「在地美食」→ M001
    const map = {
      "坑道":"K","戰史館":"W","據點":"G","海灘":"B","碉堡":"F","地標":"L","步道":"T","體驗":"Q",
      "在地文化":"C","在地美食":"M","在地飲品":"D","金門名產":"S","傳統點心":"Tn","特色風獅爺":"Ls"
    };
    const p = (map[cat] || "X");
    const n = String(i).padStart(3,"0");
    return p + n;
  }
}

/* ===== LocalStorage Keys ===== */
const LS_KEY    = "kinmen_collect_v1";
const LS_BADGE  = "kinmen_badges_v1";
const LS_ARR    = "kinmen_arrival_v1";
const LS_BADGE_CAT = "kinmen_badges_cat_v1";

/* ===== 全域徽章 ===== */
const BADGE_RULES = [
  {count:1 , name:"入門",      icon:"fa-solid fa-flag"},
  {count:3 , name:"在地達人",  icon:"fa-solid fa-compass"},
  {count:5 , name:"戰地通",    icon:"fa-solid fa-shield-halved"},
  {count:10, name:"金門之友",  icon:"fa-solid fa-wand-magic-sparkles"}
];

/* =========================================
   分類徽章門檻（把你列出的分類全補齊）
   ========================================= */
const CAT_BADGE_RULES = {
  // —— 在地文化分支 ——（你列的每一種都各自是一種分類徽章）
  "在地文化":[{count:2,name:"在地文化入門",icon:"fa-solid fa-book-open"},{count:4,name:"在地文化巡禮",icon:"fa-solid fa-chess-rook"}],
  "戰地坑道":[{count:1,name:"坑道初探",icon:"fa-solid fa-tunnel"},{count:2,name:"坑道通",icon:"fa-solid fa-person-walking"}],
  "軌條柴":[{count:1,name:"軌條柴入門",icon:"fa-solid fa-shield-halved"},{count:2,name:"軌條柴行家",icon:"fa-solid fa-shield"}],
  "洋樓建築":[{count:1,name:"洋樓入門",icon:"fa-solid fa-building-columns"},{count:2,name:"洋樓達人",icon:"fa-solid fa-landmark"}],
  "碉堡":[{count:2,name:"碉堡入門",icon:"fa-solid fa-shield-halved"},{count:4,name:"碉堡巡禮",icon:"fa-solid fa-shield"}],
  "播音牆":[{count:1,name:"心戰印記",icon:"fa-solid fa-bullhorn"},{count:2,name:"播音牆通",icon:"fa-solid fa-tower-broadcast"}],
  "太武山":[{count:1,name:"太武初遇",icon:"fa-solid fa-mountain"},{count:2,name:"太武巡禮",icon:"fa-solid fa-person-hiking"}],
  "風獅爺":[{count:1,name:"風獅小行家",icon:"fa-solid fa-wind"},{count:3,name:"風獅守護者",icon:"fa-solid fa-dragon"}],
  "風雞、北風爺":[{count:1,name:"風神入門",icon:"fa-regular fa-compass"},{count:2,name:"風神巡禮",icon:"fa-solid fa-compass"}],
  "廈門一景":[{count:1,name:"遠眺彼岸",icon:"fa-regular fa-eye"},{count:2,name:"海峽視角",icon:"fa-solid fa-binoculars"}],
  "閩南建築(古厝)":[{count:1,name:"古厝入門",icon:"fa-solid fa-house-chimney"},{count:2,name:"古厝達人",icon:"fa-solid fa-chess-rook"}],
  "濕地":[{count:1,name:"濕地初探",icon:"fa-solid fa-water"},{count:2,name:"濕地守護者",icon:"fa-solid fa-recycle"}],
  "特約茶室":[{count:1,name:"特約入門",icon:"fa-solid fa-martini-glass"},{count:2,name:"特約知行",icon:"fa-solid fa-landmark-dome"}],
  "路上黃牛":[{count:1,name:"在地相遇",icon:"fa-solid fa-cow"},{count:2,name:"與牛有約",icon:"fa-solid fa-heart"}],
  "雞頭魚尾":[{count:1,name:"地形入門",icon:"fa-solid fa-earth-asia"},{count:2,name:"地景達人",icon:"fa-solid fa-globe"}],
  "高梁田":[{count:1,name:"高粱初識",icon:"fa-solid fa-wheat-awn"},{count:2,name:"高粱巡禮",icon:"fa-solid fa-seedling"}],
  "戰時文化":[{count:1,name:"戰時印記",icon:"fa-solid fa-helmet-safety"},{count:2,name:"戰時通識",icon:"fa-solid fa-shield-virus"}],
  "摩西分海":[{count:1,name:"潮汐行者",icon:"fa-solid fa-water"}],
  "金門腔":[{count:1,name:"金門腔入門",icon:"fa-solid fa-language"},{count:2,name:"金門腔達人",icon:"fa-solid fa-comments"}],
  "戰史館":[{count:1,name:"戰史入門",icon:"fa-solid fa-landmark-dome"},{count:2,name:"戰史達人",icon:"fa-solid fa-book"}],
  "反空降樁":[{count:1,name:"樁列初識",icon:"fa-solid fa-fence"},{count:2,name:"樁列達人",icon:"fa-solid fa-road-barrier"}],
  "反空降堡":[{count:1,name:"防空降入門",icon:"fa-solid fa-person-military-pointing"},{count:2,name:"防空降達人",icon:"fa-solid fa-bullseye"}],
  "書院":[{count:1,name:"書院初探",icon:"fa-solid fa-book-open-reader"},{count:2,name:"書院通",icon:"fa-solid fa-feather-pointed"}],
  "沙灘":[{count:1,name:"海風初見",icon:"fa-solid fa-umbrella-beach"},{count:2,name:"海灘守護者",icon:"fa-solid fa-recycle"}],

  // —— 五大吃喝名產點心風獅爺（各自是一種分類徽章） ——
  "在地美食":[{count:2,name:"在地美食入門",icon:"fa-solid fa-bowl-food"},{count:4,name:"在地美食饕客",icon:"fa-solid fa-utensils"}],
  "在地飲品":[{count:1,name:"在地飲品入門",icon:"fa-solid fa-mug-hot"},{count:3,name:"在地飲品達人",icon:"fa-solid fa-martini-glass-citrus"}],
  "金門名產":[{count:2,name:"名產入門",icon:"fa-solid fa-store"},{count:4,name:"名產收藏家",icon:"fa-solid fa-bag-shopping"}],
  "傳統點心":[{count:2,name:"點心入門",icon:"fa-solid fa-cookie-bite"},{count:4,name:"點心達人",icon:"fa-solid fa-cake-candles"}],
  "特色風獅爺":[{count:1,name:"風獅小行家",icon:"fa-solid fa-wind"},{count:3,name:"風獅守護者",icon:"fa-solid fa-dragon"}]
};

/* ===== 狀態 ===== */
let state = {
  kw:"",
  cat:"all",
  collected: loadCollected(),
  unlockedBadges: loadBadgeState(),
  arrivalGranted: loadArrival(),
  unlockedCatBadges: loadCatBadgeState()
};

/* ===== 徽章佇列 ===== */
const badgeQueue = []; let isBadgeShowing = false;
function enqueueBadge(icon, title, desc){ badgeQueue.push({icon, title, desc}); processBadgeQueue(); }
function processBadgeQueue(){
  if (!window.bootstrap || isBadgeShowing || badgeQueue.length===0) return;
  const {icon, title, desc} = badgeQueue.shift(); isBadgeShowing = true;
  $("#badgeIcon").html(`<i class="${icon}"></i>`); $("#badgeTitle").text(title); $("#badgeDesc").text(desc);
  const el=document.getElementById('badgeModal'); const modal=bootstrap.Modal.getOrCreateInstance(el);
  const once=()=>{ el.removeEventListener('hidden.bs.modal', once); isBadgeShowing=false; setTimeout(processBadgeQueue,50); };
  el.addEventListener('hidden.bs.modal', once); modal.show();
}

/* ===== 啟動 ===== */
document.addEventListener('DOMContentLoaded', () => {
  try {
    renderCategoryFilters();
    ensureArrivalBadge();
    calibrateConsistency();
    initMap();

    renderList();
    renderProgress();
    renderBadgesCompact();
    wireEvents();
    tryAutoStampFromURL();
  } catch (err) { console.error('初始化失敗：', err); }
});

/* ===== 地圖 ===== */
let map, markers = {};
function initMap(){
  map = L.map('map', {scrollWheelZoom:true}).setView([24.45,118.36], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);
  markers = {};
  DATA.forEach(item=>{
    if(typeof item.lat==="number" && typeof item.lng==="number"){
      const marker = L.marker([item.lat,item.lng]).addTo(map)
        .bindPopup(`<strong>${escapeHtml(item.name)}</strong><br><span class="text-muted">${escapeHtml(item.category)}</span>`);
      marker.on('click', ()=> openItem(item.id));
      markers[item.id] = marker;
    }
  });
}
function flyToItem(item){
  if(typeof item.lat==="number" && typeof item.lng==="number"){
    map.flyTo([item.lat,item.lng], 14, {duration:.6});
    markers[item.id]?.openPopup();
  }
}

/* ===== 類別篩選 ===== */
function renderCategoryFilters(){
  const $wrap = $("#catFilters").empty();
  const cats = Array.from(new Set(DATA.map(d=>d.category))).sort();
  $wrap.append(`<span class="tag filter-pill active" data-cat="all"><i class="fa-solid fa-sliders"></i> 全部</span>`);
  cats.forEach(c=> $wrap.append(`<span class="tag filter-pill" data-cat="${escapeHtml(c)}">${escapeHtml(c)}</span>`));
}

/* ===== 清單 ===== */
function renderList(){
  const $list = $("#list").empty();
  const items = filtered().slice().sort((a,b)=>{
    const pa = (a.category === "體驗") ? 0 : 1;
    const pb = (b.category === "體驗") ? 0 : 1;
    if (pa !== pb) return pa - pb;
    return (a.name||"").localeCompare(b.name||"", 'zh-Hant');
  });
  if(items.length===0){ $("#empty").removeClass("d-none"); return; }
  $("#empty").addClass("d-none");

  items.forEach(it=>{
    const isCollected = state.collected.has(it.id);
    const col = $(`
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 ${isCollected?'collected':''}" id="card-${it.id}">
          <div class="card-body position-relative">
            <div class="d-flex justify-content-between align-items-start">
              <h5 class="card-title mb-1">${escapeHtml(it.name)}</h5>
              <span class="badge ${isCollected?'text-bg-success':'text-bg-secondary'}">${isCollected?'已蒐集':'未蒐集'}</span>
            </div>
            <div class="text-muted small mb-2"><i class="fa-solid fa-location-dot"></i> ${escapeHtml(it.category)}</div>
            <p class="card-text">${escapeHtml(it.desc||"").slice(0,88)}${(it.desc||"").length>88?'…':''}</p>
            <div class="mb-2">${(it.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-primary btn-detail" data-id="${it.id}"><i class="fa-regular fa-circle-question"></i> 詳情</button>
              <button class="btn btn-sm ${isCollected?'btn-success':'btn-outline-success'} btn-collect" data-id="${it.id}">
                <i class="fa-solid fa-stamp"></i> ${isCollected?'已蒐集':'蒐集'}
              </button>
              <button class="btn btn-sm btn-outline-secondary btn-locate" data-id="${it.id}"><i class="fa-solid fa-map-location-dot"></i> 地圖</button>
            </div>
            <div class="stamp" id="stamp-${it.id}">已集章</div>
          </div>
        </div>
      </div>
    `);
    $list.append(col);
  });
  $("#progressText").text(`${state.collected.size} / ${DATA.length}`);
  updateProgressBar();
}

/* ===== 篩選 ===== */
function filtered(){
  const kw = state.kw.trim().toLowerCase();
  const cat = state.cat;
  return DATA.filter(it=>{
    const hitCat = (cat==='all') || (it.category===cat);
    const text = (it.name + ' ' + (it.desc||'') + ' ' + (it.tags||[]).join(' ')).toLowerCase();
    const hitKw = kw==='' || text.includes(kw);
    return hitCat && hitKw;
  });
}

/* ===== 詳情 ===== */
function openItem(id){
  const it = ITEM_BY_ID[id]; if(!it) return;
  $("#mdTitle").text(it.name);
  $("#mdTags").html(`<span class="tag">${escapeHtml(it.category)}</span>${(it.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}`);
  $("#mdDesc").text(it.desc||"");
  $("#mdAddr").text(it.address || "—");
  if(typeof it.lat==="number" && typeof it.lng==="number"){
    $("#mdCoord").text(`${it.lat.toFixed(5)}, ${it.lng.toFixed(5)}`);
    $("#mdNav").attr("href", `https://www.google.com/maps?q=${it.lat},${it.lng}`).removeClass("disabled");
  }else{
    $("#mdCoord").text("—");
    $("#mdNav").attr("href","#").addClass("disabled");
  }
  $("#mdQuests").empty().append((it.quests||[]).map(q=>`<li>${escapeHtml(q)}</li>`).join(''));

  const collected = state.collected.has(it.id);
  $("#mdCollectBtn")
    .toggleClass("btn-success", !collected)
    .toggleClass("btn-outline-success", collected)
    .html(collected ? `<i class="fa-regular fa-circle-xmark"></i> 取消蒐集` : `<i class="fa-solid fa-stamp"></i> 蒐集`)
    .off("click").on("click", ()=>{
      const el = document.getElementById('itemModal');
      const modal = bootstrap.Modal.getOrCreateInstance(el);
      const once = () => {
        el.removeEventListener('hidden.bs.modal', once);
        toggleCollect(it.id);
        renderList();
        renderBadgesCompact();
      };
      el.addEventListener('hidden.bs.modal', once);
      modal.hide();
    });

  const modalEl = document.getElementById('itemModal');
  bootstrap.Modal.getOrCreateInstance(modalEl).show();

  flyToItem(it);
}

/* ===== 蒐集 + 徽章 ===== */
function toggleCollect(id){
  const item = ITEM_BY_ID[id]; if(!item) return;
  const cat = item.category;
  const beforeCat = countCollectedByCategory(cat);
  const beforeTotal = state.collected.size;

  let justAdded = false;
  if(state.collected.has(id)) state.collected.delete(id);
  else { state.collected.add(id); justAdded = true; }
  saveCollected();

  const afterTotal = state.collected.size;
  const afterCat = countCollectedByCategory(cat);

  checkBadgeUnlock(beforeTotal, afterTotal);
  checkCatBadgeUnlock(cat, beforeCat, afterCat);

  if (justAdded) {
    const el = document.getElementById(`stamp-${id}`);
    if (el){ el.classList.remove('punch'); void el.offsetWidth; el.classList.add('punch'); }
  }
}

/* ===== 儲存/載入 ===== */
function saveCollected(){ localStorage.setItem(LS_KEY, JSON.stringify([...state.collected])); renderProgress(); }
function loadCollected(){ try{ const raw = localStorage.getItem(LS_KEY); return new Set(raw? JSON.parse(raw): []);}catch(e){ return new Set(); } }
function loadBadgeState(){ try{ const raw = localStorage.getItem(LS_BADGE); return new Set(raw? JSON.parse(raw): []);}catch(e){ return new Set(); } }
function saveBadgeState(){ localStorage.setItem(LS_BADGE, JSON.stringify([...state.unlockedBadges])); }
function loadArrival(){ try{ return localStorage.getItem(LS_ARR)==="1"; }catch(e){ return false; } }
function saveArrival(v){ localStorage.setItem(LS_ARR, v? "1":"0"); }
function loadCatBadgeState(){
  try{
    const raw = localStorage.getItem(LS_BADGE_CAT);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    Object.keys(obj).forEach(k=> obj[k] = new Set(obj[k]));
    return obj;
  }catch(e){ return {}; }
}
function saveCatBadgeState(){
  const plain = {}; Object.keys(state.unlockedCatBadges).forEach(k=> plain[k] = [...state.unlockedCatBadges[k]]);
  localStorage.setItem(LS_BADGE_CAT, JSON.stringify(plain));
}

/* ===== 旅人報到 + 一致性校正 ===== */
function ensureArrivalBadge(){
  if(!state.arrivalGranted){
    state.arrivalGranted = true; saveArrival(true);
    setTimeout(()=> enqueueBadge("fa-solid fa-plane-arrival","解鎖徽章：旅人報到","歡迎來到金門！祝旅程愉快～"), 120);
  }
}
function calibrateConsistency(){
  if(state.collected.size === 0 && state.unlockedBadges.size > 0){
    state.unlockedBadges = new Set(); saveBadgeState();
  }
}

/* ===== 解鎖判斷 ===== */
function checkBadgeUnlock(beforeTotal, afterTotal){
  BADGE_RULES.forEach(b=>{
    const crossed = (beforeTotal < b.count && afterTotal >= b.count);
    if(crossed && !state.unlockedBadges.has(b.count)){
      state.unlockedBadges.add(b.count); saveBadgeState();
      enqueueBadge(b.icon, `解鎖徽章：${b.name}`, `恭喜！已蒐集 ${afterTotal} / ${DATA.length} 個點。`);
    }
  });
}
function checkCatBadgeUnlock(cat, before, after){
  const rules = CAT_BADGE_RULES[cat]; if(!rules || rules.length===0) return;
  if(!state.unlockedCatBadges[cat]) state.unlockedCatBadges[cat] = new Set();
  rules.forEach(r=>{
    const crossed = (before < r.count && after >= r.count);
    if(crossed && !state.unlockedCatBadges[cat].has(r.count)){
      state.unlockedCatBadges[cat].add(r.count); saveCatBadgeState();
      enqueueBadge(r.icon, `分類徽章：${r.name}`, `${cat} 類別已蒐集 ${after} 個！`);
    }
  });
}

/* ===== 進度/徽章（精簡顯示） ===== */
function renderProgress(){
  $("#progressText").text(`${state.collected.size} / ${DATA.length}`);
  updateProgressBar();
}
function updateProgressBar(){
  const pct = DATA.length? Math.round(state.collected.size*100/DATA.length): 0;
  $("#progressBar").css("width", pct+"%").text(pct+"%");
}
function renderBadgesCompact(){
  const $row = $("#badgesRow").empty();
  const total = state.collected.size;

  if(state.arrivalGranted){
    $row.append(`<span class="badge-chip badge-strong"><i class="fa-solid fa-plane-arrival"></i> 旅人報到</span>`);
  }

  let best = null;
  for(const rule of BADGE_RULES.slice().sort((a,b)=>b.count-a.count)){
    if(total >= rule.count){ best = rule; break; }
  }
  if(best){
    $row.append(`<span class="badge-chip badge-strong"><i class="${best.icon}"></i> ${best.name}</span>`);
  }else{
    const next = BADGE_RULES[0];
    $row.append(`<span class="badge-chip badge-muted"><i class="${next.icon}"></i> 再蒐集 ${next.count - total} 個解鎖「${next.name}」</span>`);
  }

  const cats = Array.from(new Set(DATA.map(d=>d.category))).sort();
  cats.forEach(cat=>{
    const got = countCollectedByCategory(cat);
    const sum = DATA.filter(d=>d.category===cat).length;
    $row.append(`<span class="badge-chip" title="${cat} ${got}/${sum}"><i class="fa-regular fa-bookmark"></i> ${cat} ${got}/${sum}</span>`);
  });
}

/* ===== 事件 ===== */
function wireEvents(){
  $("#kw").on("input", function(){ state.kw = $(this).val(); renderList(); });

  $("#catFilters").on("click",".filter-pill", function(){
    $("#catFilters .filter-pill").removeClass("active");
    $(this).addClass("active");
    state.cat = $(this).data("cat");
    renderList();
  });

  $("#btnReset").on("click", ()=>{
    state.kw=""; state.cat="all"; $("#kw").val("");
    $("#catFilters .filter-pill").removeClass("active");
    $("#catFilters .filter-pill[data-cat='all']").addClass("active");

    state.collected = new Set();
    state.unlockedBadges = new Set();
    state.unlockedCatBadges = {};
    saveCollected(); saveBadgeState(); saveCatBadgeState();

    state.arrivalGranted = false; 
    saveArrival(false);
    ensureArrivalBadge();

    renderList(); renderProgress(); renderBadgesCompact();
    toast("已重設，重新發放「旅人報到」徽章");
  });

  $("#list").on("click",".btn-detail", function(){ openItem($(this).data("id")); });
  $("#list").on("click",".btn-collect", function(){ const id=$(this).data("id"); toggleCollect(id); renderList(); renderBadgesCompact(); });
  $("#list").on("click",".btn-locate", function(){ const it=ITEM_BY_ID[$(this).data("id")]; if(it){ flyToItem(it); openItem(it.id); } });

  $("#btnAllBadges").on("click", ()=>{ renderAllBadges(); const el=document.getElementById('allBadgesModal'); bootstrap.Modal.getOrCreateInstance(el).show(); });
}

/* ===== 全部徽章 Modal ===== */
function renderAllBadges(){
  const $g = $("#allBadgeGlobal").empty();
  BADGE_RULES.forEach(r=>{
    const unlocked = state.collected.size >= r.count;
    $g.append(`<span class="badge-chip ${unlocked?'badge-strong':''}"><i class="${r.icon}"></i> ${r.name}（≥${r.count}）</span>`);
  });

  const $cWrap = $("#allBadgeCats").empty();
  const cats = Object.keys(CAT_BADGE_RULES);
  cats.forEach(cat=>{
    const rules = CAT_BADGE_RULES[cat];
    const got = countCollectedByCategory(cat);
    const sum = DATA.filter(d=>d.category===cat).length;
    const $sec = $(`<div class="mb-3"></div>`);
    $sec.append(`<div class="mb-1 small text-muted"><strong>${cat}</strong> 目前 ${got}/${sum}</div>`);
    const $line = $(`<div class="d-flex flex-wrap gap-2"></div>`);
    rules.forEach(r=>{
      const unlocked = got >= r.count;
      $line.append(`<span class="badge-chip ${unlocked?'badge-strong':''}"><i class="${r.icon}"></i> ${r.name}（≥${r.count}）</span>`);
    });
    $sec.append($line);
    $cWrap.append($sec);
  });
}

/* ===== URL 掃碼集章 ===== */
function tryAutoStampFromURL(){
  const params = new URLSearchParams(location.search);
  const id = params.get("stamp"); if(!id) return;
  const it = ITEM_BY_ID[id]; if(!it){ toast("找不到此項目 ID"); return; }
  if(!state.collected.has(id)){
    const beforeTotal = state.collected.size;
    const beforeCat = countCollectedByCategory(it.category);
    state.collected.add(id);
    saveCollected(); renderList(); renderBadgesCompact();
    checkBadgeUnlock(beforeTotal, state.collected.size);
    checkCatBadgeUnlock(it.category, beforeCat, countCollectedByCategory(it.category));
    toast(`已將【${it.name}】加入蒐集`);
    const el = document.getElementById(`stamp-${id}`);
    if (el){ el.classList.remove('punch'); void el.offsetWidth; el.classList.add('punch'); }
  }
}

/* ===== 小工具 ===== */
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function toast(msg){
  const id = "liveToast";
  const tpl = `
  <div id="${id}" class="toast align-items-center text-bg-dark border-0 position-fixed bottom-0 end-0 m-3" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body"><i class="fa-regular fa-circle-check me-2"></i>${escapeHtml(msg)}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>`;
  $("#"+id).remove();
  $("body").append(tpl);
  if (window.bootstrap) {
    new bootstrap.Toast(document.getElementById(id), {delay:1500}).show();
  }
}
function countCollectedByCategory(cat){
  let n = 0; state.collected.forEach(id=>{ const it = ITEM_BY_ID[id]; if(it && it.category===cat) n++; });
  return n;
}

//   鎖定
(function () {
  function setStickyVars() {
    const nav  = document.getElementById('topNav');
    const bar1 = document.querySelector('.subbar-1');
    const bar2 = document.querySelector('.subbar-2');
    const bar3 = document.querySelector('.subbar-3');

    const navH  = nav  ? nav.getBoundingClientRect().height  : 56;
    const bar1H = bar1 ? bar1.getBoundingClientRect().height : 48;
    const bar2H = bar2 ? bar2.getBoundingClientRect().height : 40;
    const bar3H = bar3 ? bar3.getBoundingClientRect().height : 48;

    document.documentElement.style.setProperty('--navH',  navH  + 'px');
    document.documentElement.style.setProperty('--bar1H', bar1H + 'px');
    document.documentElement.style.setProperty('--bar2H', bar2H + 'px');
    document.documentElement.style.setProperty('--bar3H', bar3H + 'px');
  }

  window.addEventListener('load', setStickyVars);
  window.addEventListener('resize', () => { clearTimeout(window.__stickyT); window.__stickyT = setTimeout(setStickyVars, 100); });
// 平滑監控 Collapse 展開/收合過程，讓 sticky 區塊高度不會跳動
document.addEventListener('show.bs.collapse', () => startSmoothCollapseWatch());
document.addEventListener('shown.bs.collapse', () => stopSmoothCollapseWatch());
document.addEventListener('hide.bs.collapse', () => startSmoothCollapseWatch());
document.addEventListener('hidden.bs.collapse', () => {
  stopSmoothCollapseWatch();
  setStickyVars(); // 補一次最終精確高度
});

let smoothTimer = null;
function startSmoothCollapseWatch() {
  stopSmoothCollapseWatch();
  // 在收展動畫中持續每幾毫秒重新量測高度
  smoothTimer = setInterval(setStickyVars, 16); // 約60fps
}
function stopSmoothCollapseWatch() {
  if (smoothTimer) {
    clearInterval(smoothTimer);
    smoothTimer = null;
  }
}

})();

</script>
</body>
</html>
